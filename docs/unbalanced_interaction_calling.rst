.. _RST_Unbalanced_interaction_calling:

##############################
Unbalanced interaction calling
##############################

We implemented the calling of unbalanced interactions in the Python script ``UICer.py``.
As input, this script requires a file in Diachromatic interaction format.
If a P-value threshold is specified, then this will be used for the classification of interactions.
Otherwise, a randomization procedure is used to set the P-value threshold such that the FDR
remains below a chosen threshold (5\% by default).
The output also consists of a file in Diachromatic interaction format extended by two columns, one for
P-values and one for interaction categories.
This file contains only interactions that are classifiable at the P-value threshold
used for classification.

*******************************
Running the script ``UICer.py``
*******************************

Use the following command to run the script: ::

    $ diachrscripts/UICer.py \
       --diachromatic-interaction-file diachromatic_interactions.tsv.gz \
       --fdr-threshold 0.01 \
       --iter-num 1000 \
       --thread-num 10 \
       --out-prefix out_dir/out_prefix \
       --description-tag out_prefix


Available arguments:

+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| Short option  | Long option                          | Example                               | Required  | Description                                                                                                                                                                                                                                                                                                        | Default              |
+===============+======================================+=======================================+===========+====================================================================================================================================================================================================================================================================================================================+======================+
| ``-i``        | ``--diachromatic-interaction-file``  | ``diachromatic_interactions.tsv.gz``  | yes       | Input file in Diachromatic interaction format.                                                                                                                                                                                                                                                                     | --                   |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| --            | ``--fdr-threshold``                  | ``0.01``                              | no        | The P-value is chosen so that the estimated FDR remains below this threshold.                                                                                                                                                                                                                                      | ``0.05``             |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| ``-n``        | ``--iter-num``                       | ``1000``                              | no        | Number of randomizations that will be performed.                                                                                                                                                                                                                                                                   | ``100``              |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| ``-t``        | ``--thread-num``                     | ``10``                                | no        | Number of processes in which the iterations are performed in batches of the same size.                                                                                                                                                                                                                             | ``0``                |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| ``-o``        | ``--out-prefix``                     | ``out_dir/out_prefix``                | no        | Prefix for output files, which can also contain the path to an already existing directory.                                                                                                                                                                                                                         | ``OUT_PREFIX``       |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| ``-d``        | ``--description-tag``                | ``out_prefix``                        | no        | Short description that appears in generated tables and plots.                                                                                                                                                                                                                                                      | ``DESCRIPTION_TAG``  |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| --            | ``--p-value-threshold``              | ``0.05``                              | no        | By default, the final P-value threshold is determined via randomization. If a P-value is specified, then this P-value threshold will be used as the final threshold and no randomization will be performed.                                                                                                        | ``None``             |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| --            | ``--min-inter-dist``                 | ``20000``                             | no        | Minimum interaction distance. Shorter interactions are not taken into account.                                                                                                                                                                                                                                     | ``0``                |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| --            | ``--read-pair-counts-rule``          | ``ht``                                | no        | Define how the four read pair counts will be used. Can be ``ht`` for heaviest two or ``st`` for simple/twisted.                                                                                                                                                                                                    | ``ht``               |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| --            | ``--nominal-alpha-max``              | ``0.05``                              | no        | Maximum nominal alpha at which interactions are classified as unbalanced                                                                                                                                                                                                                                           | ``0.025``            |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| --            | ``--nominal-alpha-step``             | ``0.00001``                           | no        | Step size for nominal alphas.                                                                                                                                                                                                                                                                                      | ``0.00001``          |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| --            | ``--random-seed``                    | ``0``                                 | no        | Random seed that is used for the first iteration. The random seed is incremented by ``1`` for each further iteration.                                                                                                                                                                                              | ``None``             |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| --            | ``--random-seed-shuff-inter``        | ``12``                                | no        | Random seed that is used to randomize the order of interactions after parsing.                                                                                                                                                                                                                                     | ``1``                |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+
| --            | ``--enriched-digests-file``          | ``baited_digests.bed``                | no        | BED file with digest coordinates that were selected for target enrichment. The digest coordinates must match those in the digest file from GOPHER that was used as input for Diachromatic. If such a file is passed, the enrichment tags in columns 4 and 8 of the 'interaction file are overwritten accordingly.  | ``None``             |
+---------------+--------------------------------------+---------------------------------------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+

************
Output files
************

``UICer.py`` generates a total of seven files:

+-----------------------------------------------------------------------+
| Filename                                                              |
+=======================================================================+
| ``out_dir/out_prefix_reports.txt``                                    |
+-----------------------------------------------------------------------+
| ``out_dir/out_prefix_randomization_plot.pdf``                         |
+-----------------------------------------------------------------------+
| ``out_dir/out_prefix_randomization_table.txt``                        |
+-----------------------------------------------------------------------+
| ``out_dir/out_prefix_randomization_histogram_at_threshold.pdf``       |
+-----------------------------------------------------------------------+
| ``out_dir/out_prefix_randomization_histogram_at_001.pdf``             |
+-----------------------------------------------------------------------+
| ``out_dir/out_prefix_randomization_histogram_at_005.pdf``             |
+-----------------------------------------------------------------------+
| ``out_dir/out_prefix_evaluated_and_categorized_interactions.tsv.gz``  |
+-----------------------------------------------------------------------+

The content of these files is described below.

``out_prefix_reports.txt``
==========================

This file contains reports on all processing steps.
Tab-delimited lines for individual processing steps can be extracted using appropriate tags.

For example, the following command can be used to extract the lines
with the results of the randomization procedure:

.. code-block:: console

    $ cat out_dir/out_prefix_reports.txt | grep ':TR_RANDOM:'
    :TR_RANDOM:	DESCRIPTION	INPUT_I_NUM	ITER_NUM	RANDOM_SEED	NOMINAL_ALPHA	POT_SIG_NUM	SIG_NUM_O	SIG_NUM_R_MEAN	SIG_NUM_R_SD	Z_SCORE	FDR	SIG_NUM_R_GT_OBS
    :TR_RANDOM:	DESCRIPTION_TAG	64000	100	0	0.01000	54742	54742	1702.79	38.26	1386.15	0.03111	0
    :TR_RANDOM:	DESCRIPTION_TAG	64000	100	0	0.01562	54742	54742	2603.48	47.22	1104.27	0.04756	0
    :TR_RANDOM:	DESCRIPTION_TAG	64000	100	0	0.05000	64000	64000	9642.45	90.90	598.01	0.15066	0

There are 4 rows for the randomization step:
a header row, a row for the P-value threshold determined at the chosen FDR threshold
and two rows for the P-value thresholds `0.05` and `0.01`.

+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+
| Column name           | Content                                                                                                                                          |
+=======================+==================================================================================================================================================+
| ``N_PROCESSED``       | Number of interactions in the input file.                                                                                                        |
+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+
| ``ITER_NUM``          | Number of iterations performed for the randomization step.                                                                                       |
+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+
| ``RANDOM_SEED``       | Random seed that was set when the script was executed.                                                                                           |
+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+
| ``NOMINAL_ALPHA``     | P-value threshold.                                                                                                                               |
+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+
| ``POT_SIG_NUM``       | Number of interactions that have a sufficient number of read pairs to achieve a significant test result<br>at the respective P-value threshold.  |
+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+
| ``SIG_NUM_O``         | Number of interactions that achieve a significant test result<br>at the respective P-value threshold.                                            |
+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+
| ``SIG_NUM_R_MEAN``    | Mean number of randomized interactions that achieve a significant test result<br>at the respective P-value threshold.                            |
+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+
| ``SIG_NUM_R_SD``      | Standard deviation of the number of randomized interactions that achieve a significant test result<br>at the respective P-value threshold.       |
+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+
| ``Z_SCORE``           | Z-Score, which results from ``(SIG_NUM_O - SIG_NUM_R_MEAN)/SIG_NUM_R_SD``.                                                                       |
+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+
| ``FDR``               | False discovery rate, which results from ``SIG_NUM_R_MEAN/SIG_NUM_O``.                                                                           |
+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+
| ``SIG_NUM_R_GT_OBS``  | Number of iterations in which the number of significant randomized interactions was greater than originally observed.                            |
+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+


``out_prefix_randomization_plot.pdf``
=====================================

XXXX

``out_prefix_randomization_table.txt``
======================================

XXXX

``out_prefix_randomization_histogram_at_001.pdf``
=================================================

XXXX

``out_prefix_randomization_histogram_at_005.pdf``
=================================================

XXXX

``out_prefix_evaluated_and_categorized_interactions.tsv.gz``
============================================================

XXXX



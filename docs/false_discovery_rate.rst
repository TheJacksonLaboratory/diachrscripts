.. _RST_false_discovery_rate:

####################
False discovery rate
####################

This script uses a simple procedure to estimate the FDR of directed interactions for increasing P-value thresholds.

Initially, a Diachromatic interaction file is ingested and a binomial P-value is calculated for each interaction and
stored in a list. Furthermore, the total numbers of interactions for given read pair numbers ``n`` (the sum of simple
and twisted read pairs) are stored in dictionary with ``n`` as keys and interaction numbers as values.
This dictionary is then used to generate a list of random P-values for all interactions. A random P-value for an
interaction with n read pairs is generated by drawing a number of simple read pairs s' from a binomial distribution
``B(n, p = 0.5)``, setting the number of twisted read pairs to ``t' = n - s'`` and calculating the corresponding binomial
P-value.
Finally, the FDR is estimated for increasing P-value thresholds. For each threshold, the number of significant
interactions is determined for the list of original P-values (``S_o``) and for the lists of randomized P-values
(``S_p``) and ``S_p / S_o`` is used as estimator for the FDR.

We implemented this procedure in the following script:

.. code-block:: console

    $ python diachrscripts/03_perform_fdr_analysis.py
       --diachromatic-interaction-file MK/gzdir/JAV_MK_R10.interaction.counts.table.clr_20000.tsv.gz
       --p-val-c-min 0.00025
       --p-val-c-max 0.05
       --p-val-step-size 0.00025
       --fdr-threshold 0.05
       --out-prefix MK/JAV_MK_RALT/FDR/JAV_MK_RALT

In this example,
we are applying the script to a Diachromatic interaction file for the first replicate for MK
(``--diachromatic-interaction-file``).
The FDR is calculated for increasing P-value thresholds
from ``--p-val-c-min``
to ``--p-val-c-max``
with a step size of ``--p-val-step-size``.
All calculated FDRs and the corresponding P-value thresholds are written to
a tab separated file (``--out-prefix``)
and the line with the desired FDR (``--fdr-threshold``)
is additionally output on the screen.

The script generates one file:

.. code-block:: console

    MK/JAV_MK_RALT/FDR/JAV_MK_RALT_fdr_analysis_results.txt

These are the first lines of this file up to the line
in which the calculated FDR is above the specified FDR threshold (``0.05``).
The last line in which the calculated FDR is still below the threshold
was subsequently marked with an arrow.

.. code-block:: console

    OUT_PREFIX	FDR	PC	NSIG_P	NSIG_O
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.003878727859788114	0.0001	376	96939
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.006966033903740457	0.0002	782	112259
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.011531095177042278	0.00030000000000000003	1457	126354
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.013328508533864062	0.0004	1768	132648
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.018910363781799288	0.0005	2766	146269
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.02002288329519451	0.0006000000000000001	3010	150328
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.021868671886084275	0.0007000000000000001	3391	155062
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.024751345785056698	0.0008	4014	162173
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.025583259451778622	0.0009000000000000001	4213	164678
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.03238307526066565	0.001	5724	176759
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.03334187538996346	0.0011	5985	179504
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.03588880531188952	0.0012000000000000001	6632	184793
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.03923472957590568	0.0013000000000000002	7514	191514
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.039965068029495815	0.0014000000000000002	7734	193519
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.040836216309993977	0.0015	8003	195978
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.041607002400016135	0.0016	8252	198332
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.04285223179365562	0.0017000000000000001	8601	200713
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.04672194378811623	0.0018000000000000002	9630	206113
    -> MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.04791701522502928	0.0019000000000000002	10024	209195
    MK/JAV_MK_RALT/FDR/JAV_MK_RALT	0.05701037416737231	0.002	12590	220837
    ...

The table has four columns:

+----------------+----------------------------------------------------------------------+
| Header         | Explanation                                                          |
+================+======================================================================+
| ``OUT_PREFIX`` | Prefix for output files                                              |
+----------------+----------------------------------------------------------------------+
| ``FDR``        | Calculated FDR at the given P-value threshold (``NSIG_P/NSIG_O``)    |
+----------------+----------------------------------------------------------------------+
| ``PC``         | P-value threshold                                                    |
+----------------+----------------------------------------------------------------------+
| ``NSIG_P``     | Number of randomized significant interactions at given ``PC``        |
+----------------+----------------------------------------------------------------------+
| ``NSIG_O``     | Number of significant interactions actually observed at given ``PC`` |
+----------------+----------------------------------------------------------------------+

Note that ``_P`` stands for permuted and ``_O`` for observed.
